<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/parent_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>강의 정보</title>
</head>
<body>
	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="table-responsive pt-3">
					<table class="table table-striped project-orders-table">
						<thead>
							<tr>
								<th class="ml-5">번호</th>
								<th>강의명</th>
								<th>자녀이름</th>
								<th>학원비</th>
								<th>요청일자</th>
								<th>승인일자</th>
								<th>납부여부</th>
								<th>납부</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="pay : ${payment}">
								<td th:text="${pay.chargeNumber}"></td>
								<td th:text="${pay.lectureTitle}"></td>
								<td th:text="${pay.studentName}"></td>
								<td th:text="${pay.lectureCost} + '원'"></td>
								<td th:text="${pay.RequestDate}"></td>
								<td th:text="${pay.approvalDate}"></td>
								<td th:text="${pay.receiveStatus}"></td>
								<td>
                                <div class="d-flex align-items-center">
                                    <button type="button"
                                        class="btn btn-success btn-sm btn-icon-text mr-3 payment-button"
                                        th:data-lecture-title="${pay.lectureTitle}"
                                        th:data-lecture-cost="${pay.lectureCost}"
                                        th:data-student-name="${pay.studentName}"
                                        th:data-parent-name="${#authentication.principal.member.name}"
                                        th:data-parent-phone="${#authentication.principal.member.phone}"
                                        th:data-parent-email="${#authentication.principal.member.email}"
                                        th:data-charge-number="${pay.chargeNumber}">납부</button>
                                </div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
	<script th:inline="javascript">

    document.querySelectorAll('.payment-button').forEach(function(button) {
        button.addEventListener('click', function() {
            var lectureTitle = this.getAttribute('data-lecture-title');
            var lectureCost = this.getAttribute('data-lecture-cost');
            var studentName = this.getAttribute('data-student-name');
            var parentName = this.getAttribute('data-parent-name');
            var parentPhone = this.getAttribute('data-parent-phone');
            var parentEmail = this.getAttribute('data-parent-email');
            var chargeNumber = this.getAttribute('data-charge-number');

            console.log(lectureTitle);
            requestPayment(lectureTitle, lectureCost, studentName, parentName, parentPhone, parentEmail, chargeNumber);
            
        });
    });
	
    document.addEventListener("DOMContentLoaded", function() {
        if (typeof PortOne !== 'undefined') {
            PortOne.init({
                storeId: "store-de9fb682-27f5-4a8d-a37b-96c75ee490b3"
            });
        } else {
            console.error('PortOne이 정의되지 않았습니다. 스크립트 소스를 확인해주세요.');
        }

        // 결제 버튼에 이벤트 리스너 추가
    });

    function requestPayment(lectureTitle, lectureCost, studentName, parentName, parentPhone, parentEmail, chargeNumber) {
        if (typeof PortOne !== 'undefined') {
            PortOne.requestPayment({
                storeId: "store-de9fb682-27f5-4a8d-a37b-96c75ee490b3",
                channelKey: "channel-key-21477788-3f9c-4718-a6fb-e5a8428a79f9",
                paymentId: `${crypto.randomUUID()}`,
                orderName: lectureTitle,
                totalAmount: Number(lectureCost),
                currency: "CURRENCY_KRW",
                payMethod: "CARD",
                customer: {
                    fullName: parentName,
                    phoneNumber: parentPhone,
                    email: parentEmail,
                },
                callback: function(response) {
                    if (response.status === "SUCCESS") {
                        fetch('/parent/pay/callback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(response)
                        }).then(function(res) {
                            if (res.ok) {
                                alert('결제가 성공적으로 완료되었습니다.');
                                location.reload(); // 페이지 새로고침
                            } else {
                                alert('결제 처리 중 오류가 발생했습니다.');
                            }
                        }).catch(function(error) {
                            console.error('Error:', error);
                            alert('결제 처리 중 오류가 발생했습니다.');
                        });
                    } else {
                        alert('결제에 실패했습니다: ' + response.error.message);
                    }
                }
            });
        } else {
            console.error('PortOne이 정의되지 않았습니다. 스크립트 소스를 확인해주세요.');
        }
    }
</script>
</body>
</html>